name: 'Main3: Post-Deploy'

# Reusable workflow for post-deployment verification (integration tests, smoke tests)
# Can be triggered standalone against a deployed environment or called by Main0: ALL

on:
  # Standalone trigger - select deployed environment to test (no branch needed)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployed environment to test'
        required: true
        type: choice
        options:
          - develop
          - staging
          - production
        default: develop
      pr_number:
        description: 'PR number (only for PR environments)'
        required: false
        type: string
      skip_integration_tests:
        description: 'Skip integration tests'
        type: boolean
        default: false
      skip_smoke_tests:
        description: 'Skip smoke tests'
        type: boolean
        default: false

  # Called by Main0: ALL
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
        description: 'Target environment (pr, develop, staging, production)'
      pr_number:
        type: string
        required: false
        description: 'PR number for PR environments'
      timestamp:
        type: string
        required: true
        description: 'CI run timestamp for artifact naming'
      api_url:
        type: string
        required: true
        description: 'Deployed API URL'
      auth_url:
        type: string
        required: false
        description: 'Deployed Auth URL'
      frontend_url:
        type: string
        required: true
        description: 'Deployed frontend URL'
      skip_integration_tests:
        type: boolean
        default: false
      skip_smoke_tests:
        type: boolean
        default: false
    secrets:
      GCP_PROJECT_ID:
        required: false
      TEST_USER_EMAIL:
        required: false
      TEST_USER_PASSWORD:
        required: false
    outputs:
      all_passed:
        description: 'Whether all post-deploy checks passed'
        value: ${{ jobs.post-deploy-gate.outputs.all_passed }}

jobs:
  # ============================================================================
  # Health Check - Resolve URLs and verify services are running
  # ============================================================================

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.urls.outputs.api_url }}
      frontend_url: ${{ steps.urls.outputs.frontend_url }}
      auth_url: ${{ steps.urls.outputs.auth_url }}
      timestamp: ${{ steps.urls.outputs.timestamp }}

    steps:
      - name: Resolve URLs
        id: urls
        run: |
          ENV="${{ inputs.environment }}"
          PR_NUM="${{ inputs.pr_number }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID || 'expense-tracker-project' }}"
          REGION="us-central1"

          # Use provided URLs for workflow_call, resolve for workflow_dispatch
          if [[ -n "${{ inputs.api_url }}" ]]; then
            API_URL="${{ inputs.api_url }}"
            AUTH_URL="${{ inputs.auth_url }}"
            FRONTEND_URL="${{ inputs.frontend_url }}"
          else
            # Resolve based on environment
            case $ENV in
              production)
                API_URL="https://api-service-${PROJECT}.${REGION}.run.app"
                AUTH_URL="https://auth-service-${PROJECT}.${REGION}.run.app"
                FRONTEND_URL="https://storage.googleapis.com/expense-tracker-frontend-prod/index.html"
                ;;
              staging)
                API_URL="https://api-service-staging-${PROJECT}.${REGION}.run.app"
                AUTH_URL="https://auth-service-staging-${PROJECT}.${REGION}.run.app"
                FRONTEND_URL="https://storage.googleapis.com/expense-tracker-frontend-staging/index.html"
                ;;
              develop)
                API_URL="https://api-service-dev-${PROJECT}.${REGION}.run.app"
                AUTH_URL="https://auth-service-dev-${PROJECT}.${REGION}.run.app"
                FRONTEND_URL="https://storage.googleapis.com/expense-tracker-frontend-dev/index.html"
                ;;
              pr)
                API_URL="https://api-service-pr-${PR_NUM}-${PROJECT}.${REGION}.run.app"
                AUTH_URL="https://auth-service-pr-${PR_NUM}-${PROJECT}.${REGION}.run.app"
                FRONTEND_URL="https://storage.googleapis.com/expense-tracker-frontend-pr-${PR_NUM}/index.html"
                ;;
            esac
          fi

          TIMESTAMP="${{ inputs.timestamp || '' }}"
          if [[ -z "$TIMESTAMP" ]]; then
            TIMESTAMP=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)
          fi

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "auth_url=${AUTH_URL}" >> $GITHUB_OUTPUT
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

          echo "Environment: ${ENV}"
          echo "API URL: ${API_URL}"
          echo "Auth URL: ${AUTH_URL}"
          echo "Frontend URL: ${FRONTEND_URL}"

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30

      - name: Health check - All Services (parallel)
        run: |
          API_URL="${{ steps.urls.outputs.api_url }}"
          AUTH_URL="${{ steps.urls.outputs.auth_url }}"
          FRONTEND_URL="${{ steps.urls.outputs.frontend_url }}"

          # Health check function
          check_health() {
            local name=$1
            local url=$2
            local max_attempts=$3

            echo "[$name] Checking health at ${url}..."
            for i in $(seq 1 $max_attempts); do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${url}" || echo "000")
              if [[ "$HTTP_CODE" == "200" ]]; then
                echo "[$name] Healthy (HTTP $HTTP_CODE)"
                return 0
              fi
              echo "[$name] Attempt $i/$max_attempts - HTTP $HTTP_CODE, waiting..."
              sleep 10
            done
            echo "[$name] Health check failed after $max_attempts attempts"
            return 1
          }

          # Run health checks in parallel
          check_health "API" "${API_URL}/health" 5 &
          API_PID=$!

          check_health "Auth" "${AUTH_URL}/health" 5 &
          AUTH_PID=$!

          check_health "Frontend" "${FRONTEND_URL}" 3 &
          FRONTEND_PID=$!

          # Wait for all and collect results
          API_RESULT=0
          AUTH_RESULT=0
          FRONTEND_RESULT=0

          wait $API_PID || API_RESULT=1
          wait $AUTH_PID || AUTH_RESULT=1
          wait $FRONTEND_PID || FRONTEND_RESULT=1

          # Report results
          echo ""
          echo "=== Health Check Results ==="
          [[ $API_RESULT -eq 0 ]] && echo "API: ✅ Healthy" || echo "API: ❌ Failed"
          [[ $AUTH_RESULT -eq 0 ]] && echo "Auth: ✅ Healthy" || echo "Auth: ❌ Failed"
          [[ $FRONTEND_RESULT -eq 0 ]] && echo "Frontend: ✅ Healthy" || echo "Frontend: ❌ Failed"

          # Exit with error if any failed
          if [[ $API_RESULT -ne 0 ]] || [[ $AUTH_RESULT -ne 0 ]] || [[ $FRONTEND_RESULT -ne 0 ]]; then
            echo "Some health checks failed"
            exit 1
          fi

          echo "All health checks passed"

      - name: Health check summary
        if: always()
        run: |
          echo "## Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.urls.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | ${{ steps.urls.outputs.auth_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.urls.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 5: Integration Tests
  # ============================================================================

  integration-tests:
    name: Integration Tests
    needs: [health-check]
    if: ${{ !inputs.skip_integration_tests }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: tests/node_modules
          key: ${{ runner.os }}-test-modules-${{ hashFiles('tests/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-test-modules-

      - name: Install test dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci
        working-directory: tests

      - name: Run integration tests
        run: npm run test:integration -- --maxWorkers=2 --forceExit
        working-directory: tests
        timeout-minutes: 15
        env:
          API_URL: ${{ needs.health-check.outputs.api_url }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        continue-on-error: true

      - name: Organize test results
        if: always()
        run: |
          mkdir -p reports/${{ needs.health-check.outputs.timestamp }}/integration-tests
          if [ -d "reports" ]; then
            find reports -maxdepth 1 -type f -exec mv {} reports/${{ needs.health-check.outputs.timestamp }}/integration-tests/ \; 2>/dev/null || true
          fi
        working-directory: tests

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-tests-${{ needs.health-check.outputs.timestamp }}
          path: tests/reports/${{ needs.health-check.outputs.timestamp }}/integration-tests/
          retention-days: 30

  # ============================================================================
  # STAGE 6: Smoke Tests (runs after integration tests)
  # ============================================================================

  smoke-tests:
    name: Smoke Tests
    needs: [health-check, integration-tests]
    if: ${{ !inputs.skip_smoke_tests && (success() || needs.integration-tests.result == 'skipped') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: tests/node_modules
          key: ${{ runner.os }}-test-modules-${{ hashFiles('tests/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-test-modules-

      - name: Install test dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci
        working-directory: tests

      - name: Run smoke tests
        run: npm run test:smoke -- --maxWorkers=2 --forceExit
        working-directory: tests
        timeout-minutes: 10
        env:
          API_URL: ${{ needs.health-check.outputs.api_url }}
          FRONTEND_URL: ${{ needs.health-check.outputs.frontend_url }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        continue-on-error: true

      - name: Organize test results
        if: always()
        run: |
          mkdir -p reports/${{ needs.health-check.outputs.timestamp }}/smoke-tests
          if [ -d "reports" ]; then
            find reports -maxdepth 1 -type f -exec mv {} reports/${{ needs.health-check.outputs.timestamp }}/smoke-tests/ \; 2>/dev/null || true
          fi
        working-directory: tests

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-tests-${{ needs.health-check.outputs.timestamp }}
          path: tests/reports/${{ needs.health-check.outputs.timestamp }}/smoke-tests/
          retention-days: 30

  # ============================================================================
  # Post-Deploy Gate - Check if all post-deployment stages passed
  # ============================================================================

  post-deploy-gate:
    name: Post-Deploy Gate
    needs: [health-check, integration-tests, smoke-tests]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      all_passed: ${{ steps.check.outputs.all_passed }}

    steps:
      - name: Check post-deployment results
        id: check
        run: |
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"

          INTEGRATION="${{ needs.integration-tests.result }}"
          SMOKE="${{ needs.smoke-tests.result }}"

          # All must be success or skipped
          if [[ "$INTEGRATION" =~ ^(success|skipped)$ ]] && \
             [[ "$SMOKE" =~ ^(success|skipped)$ ]]; then
            echo "All post-deployment checks passed"
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Some post-deployment checks failed"
            echo "all_passed=false" >> $GITHUB_OUTPUT
            # Don't fail - post-deploy tests are informational
          fi

      - name: Summary
        run: |
          echo "## Post-Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ needs.health-check.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ needs.health-check.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
