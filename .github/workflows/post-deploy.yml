name: 'Main3: Post-Deploy'

# Reusable workflow for post-deployment verification (integration tests, smoke tests)
# Can be triggered standalone against a deployed environment or called by Main0: ALL

on:
  # Standalone trigger - select deployed environment to test (no branch needed)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployed environment to test'
        required: true
        type: choice
        options:
          - develop
          - staging
          - production
        default: develop
      auth_url:
        type: string
        required: false
        description: 'Deployed Auth URL'
      frontend_url:
        type: string
        required: true
        description: 'Deployed frontend URL'
      api_url:
        type: string
        required: false
        description: 'Deployed API URL (optional override)'
      pr_number:
        type: string
        required: false
        description: 'Pull request number (for PR environments)'
      timestamp:
        type: string
        required: false
        description: 'Optional timestamp to namespace artifacts'
      skip_integration_tests:
        type: boolean
        default: false
      skip_smoke_tests:
        type: boolean
        default: false

  # Allow this workflow to be called as a reusable workflow
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      pr_number:
        type: string
        required: false
      timestamp:
        type: string
        required: false
      api_url:
        type: string
        required: false
      auth_url:
        type: string
        required: false
      frontend_url:
        type: string
        required: false
      skip_integration_tests:
        type: boolean
        default: false
      skip_smoke_tests:
        type: boolean
        default: false
    secrets:
      GCP_PROJECT_ID:
        required: false
      GCP_SA_KEY:
        required: false
      TEST_USER_EMAIL:
        required: false
      TEST_USER_PASSWORD:
        required: false
    outputs:
      all_passed:
        description: 'Whether all post-deploy checks passed'
        value: ${{ jobs.post-deploy-gate.outputs.all_passed }}

jobs:
  # ============================================================================
  # Resolve URLs - shared setup for health checks
  # ============================================================================

  resolve-urls:
    name: Resolve URLs
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.urls.outputs.api_url }}
      auth_url: ${{ steps.urls.outputs.auth_url }}
      frontend_url: ${{ steps.urls.outputs.frontend_url }}
      timestamp: ${{ steps.urls.outputs.timestamp }}

    steps:
      - name: Authenticate to Google Cloud
        if: ${{ !inputs.api_url }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        if: ${{ !inputs.api_url }}
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve URLs
        id: urls
        env:
          ENV: ${{ inputs.environment }}
          PR_NUM: ${{ inputs.pr_number }}
          INPUT_API_URL: ${{ inputs.api_url }}
          INPUT_AUTH_URL: ${{ inputs.auth_url }}
          INPUT_FRONTEND_URL: ${{ inputs.frontend_url }}
          INPUT_TIMESTAMP: ${{ inputs.timestamp }}
        run: |
          REGION="us-central1"

          # Use provided URLs for workflow_call, resolve via gcloud for workflow_dispatch
          if [[ -n "${INPUT_API_URL}" ]]; then
            API_URL="${INPUT_API_URL}"
            AUTH_URL="${INPUT_AUTH_URL}"
            FRONTEND_URL="${INPUT_FRONTEND_URL}"
          else
            # Determine service suffix based on environment
            case $ENV in
              production)
                API_SERVICE="api-service"
                AUTH_SERVICE="auth-service"
                FRONTEND_BUCKET="expense-tracker-frontend-prod"
                ;;
              staging)
                API_SERVICE="api-service-staging"
                AUTH_SERVICE="auth-service-staging"
                FRONTEND_BUCKET="expense-tracker-frontend-staging"
                ;;
              develop)
                API_SERVICE="api-service-develop"
                AUTH_SERVICE="auth-service-develop"
                FRONTEND_BUCKET="expense-tracker-frontend-dev"
                ;;
              pr)
                API_SERVICE="api-service-pr-${PR_NUM}"
                AUTH_SERVICE="auth-service-pr-${PR_NUM}"
                FRONTEND_BUCKET="expense-tracker-frontend-pr-${PR_NUM}"
                ;;
            esac

            # Fetch actual URLs from Cloud Run (avoids secret masking issue)
            API_URL=$(gcloud run services describe ${API_SERVICE} --region=${REGION} --format='value(status.url)' 2>/dev/null || echo "")
            AUTH_URL=$(gcloud run services describe ${AUTH_SERVICE} --region=${REGION} --format='value(status.url)' 2>/dev/null || echo "")
            FRONTEND_URL="https://storage.googleapis.com/${FRONTEND_BUCKET}/index.html"

            if [[ -z "$API_URL" ]]; then
              echo "::error::Failed to get API service URL for ${API_SERVICE}"
              exit 1
            fi
            if [[ -z "$AUTH_URL" ]]; then
              echo "::error::Failed to get Auth service URL for ${AUTH_SERVICE}"
              exit 1
            fi
          fi

          TIMESTAMP="${INPUT_TIMESTAMP}"
          if [[ -z "$TIMESTAMP" ]]; then
            TIMESTAMP=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)
          fi

          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "auth_url=${AUTH_URL}" >> $GITHUB_OUTPUT
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

          echo "Environment: ${ENV}"
          echo "API URL: ${API_URL}"
          echo "Auth URL: ${AUTH_URL}"
          echo "Frontend URL: ${FRONTEND_URL}"

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30

  # ============================================================================
  # Health Checks - Run in parallel as separate jobs
  # ============================================================================

  health-api:
    name: Health Check - API
    needs: [resolve-urls]
    runs-on: ubuntu-latest

    steps:
      - name: Check API health
        run: |
          API_URL="${{ needs.resolve-urls.outputs.api_url }}"
          echo "Checking API service at ${API_URL}/health..."

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health" || echo "000")
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "API service is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/5 - API returned HTTP $HTTP_CODE, waiting..."
            sleep 10
          done

          echo "API service health check failed after 5 attempts"
          exit 1

  health-auth:
    name: Health Check - Auth
    needs: [resolve-urls]
    runs-on: ubuntu-latest

    steps:
      - name: Check Auth health
        run: |
          AUTH_URL="${{ needs.resolve-urls.outputs.auth_url }}"
          echo "Checking Auth service at ${AUTH_URL}/health..."

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${AUTH_URL}/health" || echo "000")
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Auth service is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/5 - Auth returned HTTP $HTTP_CODE, waiting..."
            sleep 10
          done

          echo "Auth service health check failed after 5 attempts"
          exit 1

  health-frontend:
    name: Health Check - Frontend
    needs: [resolve-urls]
    runs-on: ubuntu-latest

    steps:
      - name: Check Frontend health
        run: |
          FRONTEND_URL="${{ needs.resolve-urls.outputs.frontend_url }}"
          echo "Checking Frontend at ${FRONTEND_URL}..."

          for i in {1..3}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${FRONTEND_URL}" || echo "000")
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Frontend is accessible (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i/3 - Frontend returned HTTP $HTTP_CODE, waiting..."
            sleep 5
          done

          echo "Frontend health check failed after 3 attempts"
          exit 1

  health-check:
    name: Health Check Summary
    needs: [resolve-urls, health-api, health-auth, health-frontend]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ needs.resolve-urls.outputs.api_url }}
      frontend_url: ${{ needs.resolve-urls.outputs.frontend_url }}
      auth_url: ${{ needs.resolve-urls.outputs.auth_url }}
      timestamp: ${{ needs.resolve-urls.outputs.timestamp }}

    steps:
      - name: Health check summary
        run: |
          echo "## Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.health-api.result }} | ${{ needs.resolve-urls.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | ${{ needs.health-auth.result }} | ${{ needs.resolve-urls.outputs.auth_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.health-frontend.result }} | ${{ needs.resolve-urls.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check results
        run: |
          API="${{ needs.health-api.result }}"
          AUTH="${{ needs.health-auth.result }}"
          FRONTEND="${{ needs.health-frontend.result }}"

          echo "API: $API"
          echo "Auth: $AUTH"
          echo "Frontend: $FRONTEND"

          if [[ "$API" != "success" ]] || [[ "$AUTH" != "success" ]] || [[ "$FRONTEND" != "success" ]]; then
            echo "Some health checks failed"
            exit 1
          fi

          echo "All health checks passed"

  # ============================================================================
  # STAGE 5: Integration Tests
  # ============================================================================

  integration-tests:
    name: Integration Tests
    needs: [health-check]
    if: ${{ !inputs.skip_integration_tests }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: tests/node_modules
          key: ${{ runner.os }}-test-modules-${{ hashFiles('tests/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-test-modules-

      - name: Install test dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci
        working-directory: tests

      - name: Run integration tests
        run: npm run test:integration -- --maxWorkers=2 --forceExit
        working-directory: tests
        timeout-minutes: 15
        env:
          API_URL: ${{ needs.health-check.outputs.api_url }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        continue-on-error: true

      - name: Organize test results
        if: always()
        run: |
          DEST=reports/${{ needs.health-check.outputs.timestamp }}/integration-tests
          mkdir -p "$DEST"
          if [ -d "reports" ]; then
            shopt -s nullglob || true
            for entry in reports/*; do
              if [ "$entry" = "reports/${{ needs.health-check.outputs.timestamp }}" ] || [ "$entry" = "$DEST" ]; then
                continue
              fi
              mv "$entry" "$DEST/" 2>/dev/null || true
            done
          fi
        working-directory: tests

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-tests-${{ needs.health-check.outputs.timestamp }}
          path: |
            tests/reports/**
            tests/test-results/**
          retention-days: 30
          if-no-files-found: warn

  # ============================================================================
  # STAGE 6: Smoke Tests (runs after integration tests)
  # ============================================================================

  smoke-tests:
    name: Smoke Tests
    needs: [health-check, integration-tests]
    if: ${{ !inputs.skip_smoke_tests && (inputs.environment == 'develop' || inputs.environment == 'staging' || inputs.pr_number != '') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: tests/node_modules
          key: ${{ runner.os }}-test-modules-${{ hashFiles('tests/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-test-modules-

      - name: Install test dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci
        working-directory: tests

      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        working-directory: tests

      - name: Run Playwright smoke tests against deployed frontend
        run: |
          echo "Running Playwright smoke tests against deployed frontend: ${{ needs.health-check.outputs.frontend_url }}"
          BASE_URL=${{ needs.health-check.outputs.frontend_url }} \
            TEST_ENV=${{ inputs.environment }} \
            HEADLESS=true \
            npm run test:e2e:smoke -- --reporter=dot --workers=2
        working-directory: tests
        timeout-minutes: 20

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-reports-${{ needs.health-check.outputs.timestamp }}
          path: |
            tests/test-results/**
            tests/reports/**
          retention-days: 30
          if-no-files-found: warn

  # ============================================================================
  # Post-Deploy Gate - Check if all post-deployment stages passed
  # ============================================================================

  post-deploy-gate:
    name: Post-Deploy Gate
    needs: [health-check, integration-tests, smoke-tests]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      all_passed: ${{ steps.check.outputs.all_passed }}

    steps:
      - name: Check post-deployment results
        id: check
        run: |
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"

          INTEGRATION="${{ needs.integration-tests.result }}"
          SMOKE="${{ needs.smoke-tests.result }}"

          # All must be success or skipped
          if [[ "$INTEGRATION" =~ ^(success|skipped)$ ]] && \
             [[ "$SMOKE" =~ ^(success|skipped)$ ]]; then
            echo "All post-deployment checks passed"
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Some post-deployment checks failed"
            echo "all_passed=false" >> $GITHUB_OUTPUT
            # Don't fail - post-deploy tests are informational
          fi

      - name: Summary
        run: |
          echo "## Post-Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ needs.health-check.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ needs.health-check.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
