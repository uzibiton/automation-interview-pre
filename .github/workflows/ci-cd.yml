name: CI/CD Pipeline

# Triggers: When to run this workflow
on:
  # Trigger on push to main branch - deploys to staging automatically
  push:
    branches:
      - main

  # Trigger on pull requests - deploys to temporary PR environment
  pull_request:
    branches:
      - main

  # Manual trigger for production deployment only
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (production only via manual trigger)'
        required: true
        type: choice
        options:
          - production
        default: production

# Prevent concurrent deployments to the same environment
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.ref }}
  cancel-in-progress: false

# Define jobs that run in sequence
jobs:
  # ============================================================================
  # JOB 1: Run Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install test dependencies
        run: npm ci
        working-directory: tests/config

      - name: Run unit tests
        run: npm run test:unit
        working-directory: tests/config

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: tests/config/coverage/

  # ============================================================================
  # JOB 2: Determine Deployment Environment
  # ============================================================================
  setup:
    name: Setup Environment
    needs: unit-tests
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set_env.outputs.env_name }}
      env_suffix: ${{ steps.set_env.outputs.env_suffix }}
      should_run_e2e: ${{ steps.set_env.outputs.should_run_e2e }}

    steps:
      - name: Determine environment
        id: set_env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger = production
            echo "env_name=production" >> $GITHUB_OUTPUT
            echo "env_suffix=" >> $GITHUB_OUTPUT
            echo "should_run_e2e=false" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR = temporary environment
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "env_name=pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "env_suffix=-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
          else
            # Push to main = staging
            echo "env_name=staging" >> $GITHUB_OUTPUT
            echo "env_suffix=-staging" >> $GITHUB_OUTPUT
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # JOB 3: Build Docker Images
  # ============================================================================
  build:
    name: Build Services
    needs: setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build Auth Service
        run: |
          cd services/auth-service
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:latest .

      - name: Build API Service
        run: |
          cd services/api-service
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:latest .

      - name: Build Frontend
        run: |
          cd frontend
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend:latest .

      - name: Push images to GCR
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:latest
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:latest
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend:latest

  # ============================================================================
  # JOB 4: Deploy to Cloud Run
  # ============================================================================
  deploy:
    name: Deploy to ${{ needs.setup.outputs.env_name }}
    needs: [setup, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set deployment configuration
        id: config
        run: |
          echo "suffix=${{ needs.setup.outputs.env_suffix }}" >> $GITHUB_OUTPUT
          echo "region=us-central1" >> $GITHUB_OUTPUT

      - name: Deploy Frontend (initial)
        run: |
          gcloud run deploy frontend${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "VITE_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"

      - name: Get Frontend URL
        id: frontend_url
        run: |
          FRONTEND_URL=$(gcloud run services describe frontend${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Deploy Auth Service
        id: auth_service
        run: |
          AUTH_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)' 2>/dev/null || echo "")
          if [ -z "$AUTH_URL" ]; then
            AUTH_URL="https://auth-service${{ steps.config.outputs.suffix }}-buuath6a3q-uc.a.run.app"
          fi
          GOOGLE_CALLBACK_URL="$AUTH_URL/auth/google/callback"
          echo "âš ï¸  Google OAuth Callback URL: $GOOGLE_CALLBACK_URL"
          echo "âš ï¸  Add this URL to Google Cloud Console: https://console.cloud.google.com/apis/credentials"
          gcloud run deploy auth-service${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "DATABASE_TYPE=firestore,FIREBASE_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},JWT_SECRET=${{ secrets.JWT_SECRET }},GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }},FRONTEND_URL=${{ steps.frontend_url.outputs.url }},GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL"

      - name: Deploy API Service
        run: |
          AUTH_SERVICE_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          gcloud run deploy api-service${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "DATABASE_TYPE=firestore,FIREBASE_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},AUTH_SERVICE_URL=$AUTH_SERVICE_URL"

      - name: Update Frontend with all URLs
        run: |
          AUTH_SERVICE_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          API_SERVICE_URL=$(gcloud run services describe api-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          gcloud run deploy frontend${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/frontend:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "VITE_AUTH_SERVICE_URL=$AUTH_SERVICE_URL,VITE_API_SERVICE_URL=$API_SERVICE_URL,VITE_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"

      - name: Capture deployment URLs
        id: urls
        run: |
          AUTH_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          API_URL=$(gcloud run services describe api-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe frontend${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')

          echo "auth_url=$AUTH_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

          echo "ðŸš€ Deployment Complete to ${{ needs.setup.outputs.env_name }}!"
          echo "Frontend: $FRONTEND_URL"
          echo "API: $API_URL"
          echo "Auth: $AUTH_URL"

    outputs:
      frontend_url: ${{ steps.urls.outputs.frontend_url }}
      api_url: ${{ steps.urls.outputs.api_url }}
      auth_url: ${{ steps.urls.outputs.auth_url }}

  # ============================================================================
  # JOB 5: Run E2E Smoke Tests (PR and Staging only)
  # ============================================================================
  e2e-tests:
    name: E2E Smoke Tests
    needs: [setup, deploy]
    runs-on: ubuntu-latest
    if: ${{ needs.setup.outputs.should_run_e2e == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create dynamic environment file
        run: |
          cat > tests/config/.env.${{ needs.setup.outputs.env_name }} << EOF
          BASE_URL=${{ needs.deploy.outputs.frontend_url }}
          API_URL=${{ needs.deploy.outputs.api_url }}
          AUTH_URL=${{ needs.deploy.outputs.auth_url }}
          TEST_USER_EMAIL=test@example.com
          TEST_USER_PASSWORD=testpassword123
          EOF

      - name: Run E2E smoke tests
        run: TEST_ENV=${{ needs.setup.outputs.env_name }} npm run test:e2e:smoke
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ needs.setup.outputs.env_name }}
          path: |
            tests/reports/
            test-results/
          retention-days: 7

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const envName = '${{ needs.setup.outputs.env_name }}';
            const frontendUrl = '${{ needs.deploy.outputs.frontend_url }}';

            let message = `## ðŸ§ª E2E Test Results for ${envName}\n\n`;
            message += `**Environment URL**: ${frontendUrl}\n\n`;

            if ('${{ job.status }}' === 'success') {
              message += 'âœ… All smoke tests passed!\n\n';
              message += '**Next Steps:**\n';
              message += '1. Review the deployed environment\n';
              message += '2. Once approved, this will deploy to staging when merged to main\n';
            } else {
              message += 'âŒ Some tests failed. Please check the workflow logs.\n\n';
              message += '**Action Required:** Fix failing tests before merging.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.setup.outputs.env_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL**: ${{ needs.deploy.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All smoke tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
