name: CI/CD Pipeline

run-name: "${{ github.event_name == 'pull_request' && format('PR #{0} - {1}', github.event.pull_request.number, github.event.pull_request.title) || format('{0} â†’ {1}', github.ref_name, github.event_name) }}"

# Triggers: When to run this workflow
on:
  # Trigger on push to main branch - deploys to staging automatically
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'

  # Trigger on pull requests - deploys to temporary PR environment
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/ISSUE_TEMPLATE/**'

  # Manual trigger for any environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      skip_static_analysis:
        description: 'Skip static analysis'
        required: false
        type: boolean
        default: false
      skip_unit_tests:
        description: 'Skip unit tests'
        required: false
        type: boolean
        default: false
      skip_coverage:
        description: 'Skip coverage report'
        required: false
        type: boolean
        default: false
      skip_prettier:
        description: 'Skip Prettier check'
        required: false
        type: boolean
        default: true
      skip_eslint:
        description: 'Skip ESLint'
        required: false
        type: boolean
        default: true
      skip_typecheck:
        description: 'Skip TypeScript check'
        required: false
        type: boolean
        default: true
      skip_audit:
        description: 'Skip npm audit'
        required: false
        type: boolean
        default: true
      skip_snyk:
        description: 'Skip Snyk scan'
        required: false
        type: boolean
        default: false

# Prevent concurrent deployments to the same environment
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.ref }}
  cancel-in-progress: false

# Define jobs that run in parallel
jobs:
  # ============================================================================
  # STAGE 1: Static Analysis (parallel execution)
  # ============================================================================

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Start Code Quality Checks
        run: echo "Starting code quality checks"

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Start Security Checks
        run: echo "Starting security checks"

  prettier:
    name: Code Formatting
    needs: code-quality
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_prettier != 'false' }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

  eslint:
    name: Linting
    needs: code-quality
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_eslint != 'false' }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  typecheck:
    name: Type Check
    needs: code-quality
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_typecheck != 'false' }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

  npm-audit:
    name: Dependency Audit
    needs: security-checks
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_audit != 'true' }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate

  snyk:
    name: Security Scan
    needs: security-checks
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_snyk != 'true' }}
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk scan
        id: snyk
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --all-projects --sarif-file-output=snyk.sarif

      - name: Organize security results
        if: always() && hashFiles('snyk.sarif') != ''
        run: |
          mkdir -p reports/${{ steps.timestamp.outputs.value }}/security-scan
          mv snyk.sarif reports/${{ steps.timestamp.outputs.value }}/security-scan/

      - name: Upload SARIF as artifact
        if: always() && hashFiles('reports/${{ steps.timestamp.outputs.value }}/security-scan/snyk.sarif') != ''
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ steps.timestamp.outputs.value }}
          path: reports/${{ steps.timestamp.outputs.value }}/security-scan/
          retention-days: 30

      - name: Upload results to GitHub Security
        if: always() && hashFiles('reports/${{ steps.timestamp.outputs.value }}/security-scan/snyk.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/${{ steps.timestamp.outputs.value }}/security-scan/snyk.sarif

      - name: Fail on vulnerabilities (non-blocking)
        if: steps.snyk.outcome == 'failure'
        run: |
          echo "âŒ Snyk found high or critical vulnerabilities!"
          echo "Review the SARIF artifact or GitHub Security tab for details"
          exit 1

  # ============================================================================
  # STAGE 2: Unit Tests (runs in parallel with static analysis)
  # ============================================================================

  unit-tests:
    name: Unit Tests
    if: github.event.inputs.skip_unit_tests != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)" >> $GITHUB_OUTPUT

      - name: Install test dependencies
        run: npm ci
        working-directory: tests

      - name: Run unit tests
        run: |
          mkdir -p reports/${{ steps.timestamp.outputs.value }}/unit-tests
          npm run test:unit -- --maxWorkers=2 --forceExit
        working-directory: tests
        timeout-minutes: 5

      - name: Organize test results
        if: always()
        run: |
          if [ -d "reports" ]; then
            mv reports/* reports/${{ steps.timestamp.outputs.value }}/unit-tests/ 2>/dev/null || true
          fi
        working-directory: tests

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-tests-${{ steps.timestamp.outputs.value }}
          path: tests/reports/${{ steps.timestamp.outputs.value }}/unit-tests/

  # ============================================================================
  # STAGE 2.5: Code Coverage (runs after unit tests)
  # ============================================================================

  coverage:
    name: Code Coverage
    needs: unit-tests
    if: github.event.inputs.skip_coverage != 'true' && github.event.inputs.skip_unit_tests != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)" >> $GITHUB_OUTPUT

      - name: Install test dependencies
        run: npm ci
        working-directory: tests

      - name: Run tests with coverage
        run: npm run test:coverage -- --maxWorkers=2 --forceExit
        working-directory: tests
        timeout-minutes: 10

      - name: Organize coverage results
        if: always()
        run: |
          mkdir -p reports/${{ steps.timestamp.outputs.value }}/coverage
          if [ -d "coverage" ]; then
            mv coverage reports/${{ steps.timestamp.outputs.value }}/coverage/
          fi
        working-directory: tests

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ steps.timestamp.outputs.value }}
          path: tests/reports/${{ steps.timestamp.outputs.value }}/coverage/

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageFile = 'tests/coverage/coverage-summary.json';

            if (fs.existsSync(coverageFile)) {
              const coverage = JSON.parse(fs.readFileSync(coverageFile, 'utf8'));
              const total = coverage.total;
              
              const body = `## ðŸ“Š Code Coverage Report
              
              | Metric | Coverage |
              |--------|----------|
              | Lines | ${total.lines.pct}% |
              | Statements | ${total.statements.pct}% |
              | Functions | ${total.functions.pct}% |
              | Branches | ${total.branches.pct}% |
              
              <details>
              <summary>View Details</summary>
              
              - **Lines**: ${total.lines.covered}/${total.lines.total}
              - **Statements**: ${total.statements.covered}/${total.statements.total}
              - **Functions**: ${total.functions.covered}/${total.functions.total}
              - **Branches**: ${total.branches.covered}/${total.branches.total}
              </details>`;
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            } else {
              console.log('Coverage summary file not found');
            }

  # ============================================================================
  # Setup Environment
  # ============================================================================
  setup:
    name: Setup Environment
    needs: [prettier, eslint, typecheck, npm-audit, snyk, unit-tests, coverage]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.set_env.outputs.env_name }}
      env_suffix: ${{ steps.set_env.outputs.env_suffix }}
      should_run_e2e: ${{ steps.set_env.outputs.should_run_e2e }}

    steps:
      - name: Determine environment
        id: set_env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input
            ENV="${{ github.event.inputs.environment }}"
            if [ "$ENV" = "production" ]; then
              echo "env_name=production" >> $GITHUB_OUTPUT
              echo "env_suffix=" >> $GITHUB_OUTPUT
              echo "should_run_e2e=false" >> $GITHUB_OUTPUT
            else
              echo "env_name=staging" >> $GITHUB_OUTPUT
              echo "env_suffix=-staging" >> $GITHUB_OUTPUT
              echo "should_run_e2e=true" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR = temporary environment
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "env_name=pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "env_suffix=-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
          else
            # Push to main = staging
            echo "env_name=staging" >> $GITHUB_OUTPUT
            echo "env_suffix=-staging" >> $GITHUB_OUTPUT
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # STAGE 3: Build App
  # ============================================================================

  build-auth:
    name: Auth Service
    needs: setup
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and push Auth Service
        run: |
          cd app/services/auth-service
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:latest .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:latest

  build-api:
    name: API Service
    needs: setup
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and push API Service
        run: |
          cd app/services/api-service
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:latest .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:latest

  build-frontend:
    name: Frontend
    needs: setup
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and push Frontend
        run: |
          cd app/frontend
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/expense-tracker:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/expense-tracker:latest .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/expense-tracker:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/expense-tracker:latest

  # ============================================================================
  # Deploy to Cloud Run
  # ============================================================================
  deploy:
    name: Deploy to ${{ needs.setup.outputs.env_name }}
    needs: [setup, build-auth, build-api, build-frontend]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set deployment configuration
        id: config
        run: |
          echo "suffix=${{ needs.setup.outputs.env_suffix }}" >> $GITHUB_OUTPUT
          echo "region=us-central1" >> $GITHUB_OUTPUT

      - name: Deploy Frontend (initial)
        run: |
          gcloud run deploy expense-tracker${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/expense-tracker:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "VITE_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"

      - name: Get Frontend URL
        id: frontend_url
        run: |
          FRONTEND_URL=$(gcloud run services describe expense-tracker${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Deploy Auth Service
        id: auth_service
        run: |
          AUTH_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)' 2>/dev/null || echo "")
          if [ -z "$AUTH_URL" ]; then
            AUTH_URL="https://auth-service${{ steps.config.outputs.suffix }}-buuath6a3q-uc.a.run.app"
          fi
          GOOGLE_CALLBACK_URL="$AUTH_URL/auth/google/callback"
          echo "url=$AUTH_URL" >> $GITHUB_OUTPUT
          echo "callback_url=$GOOGLE_CALLBACK_URL" >> $GITHUB_OUTPUT
          echo "âš ï¸  Google OAuth Callback URL: $GOOGLE_CALLBACK_URL"
          echo "âš ï¸  Add this URL to Google Cloud Console: https://console.cloud.google.com/apis/credentials"
          gcloud run deploy auth-service${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/auth-service:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production,DATABASE_TYPE=firestore,FIREBASE_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},JWT_SECRET=${{ secrets.JWT_SECRET }},GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }},FRONTEND_URL=${{ steps.frontend_url.outputs.url }},GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL"

      - name: Deploy API Service
        run: |
          AUTH_SERVICE_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          gcloud run deploy api-service${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/api-service:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production,DATABASE_TYPE=firestore,FIREBASE_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},AUTH_SERVICE_URL=$AUTH_SERVICE_URL"

      - name: Update Frontend with all URLs
        run: |
          AUTH_SERVICE_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          API_SERVICE_URL=$(gcloud run services describe api-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          gcloud run deploy expense-tracker${{ steps.config.outputs.suffix }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/expense-tracker:${{ github.sha }} \
            --region ${{ steps.config.outputs.region }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "VITE_AUTH_SERVICE_URL=$AUTH_SERVICE_URL,VITE_API_SERVICE_URL=$API_SERVICE_URL,VITE_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"

      - name: Capture deployment URLs
        id: urls
        run: |
          AUTH_URL=$(gcloud run services describe auth-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          API_URL=$(gcloud run services describe api-service${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe expense-tracker${{ steps.config.outputs.suffix }} --region ${{ steps.config.outputs.region }} --format='value(status.url)')

          echo "auth_url=$AUTH_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

          echo "ðŸš€ Deployment Complete to ${{ needs.setup.outputs.env_name }}!"
          echo "Frontend: $FRONTEND_URL"
          echo "API: $API_URL"
          echo "Auth: $AUTH_URL"

    outputs:
      frontend_url: ${{ steps.urls.outputs.frontend_url }}
      api_url: ${{ steps.urls.outputs.api_url }}
      auth_url: ${{ steps.urls.outputs.auth_url }}
      callback_url: ${{ steps.auth_service.outputs.callback_url }}

  # ============================================================================
  # STAGE 4: Integration Tests
  # ============================================================================

  integration-tests:
    name: Integration Tests
    needs: [setup, deploy]
    runs-on: ubuntu-latest
    if: ${{ needs.setup.outputs.should_run_e2e == 'true' && always() }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: tests

      - name: Run integration tests
        run: npm run test:integration
        working-directory: tests
        env:
          API_URL: ${{ needs.deploy.outputs.api_url }}
          AUTH_URL: ${{ needs.deploy.outputs.auth_url }}

      - name: Generate timestamp
        if: always()
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)" >> $GITHUB_OUTPUT

      - name: Organize test results
        if: always()
        run: |
          mkdir -p reports/${{ steps.timestamp.outputs.value }}/integration-tests
          if [ -d "reports" ]; then
            find reports -maxdepth 1 -type f -exec mv {} reports/${{ steps.timestamp.outputs.value }}/integration-tests/ \; 2>/dev/null || true
          fi
          if [ -d "test-results" ]; then
            mv test-results reports/${{ steps.timestamp.outputs.value }}/integration-tests/ 2>/dev/null || true
          fi
        working-directory: tests

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-tests-${{ steps.timestamp.outputs.value }}
          path: tests/reports/${{ steps.timestamp.outputs.value }}/integration-tests/

  # ============================================================================
  # STAGE 5: Smoke Tests
  # ============================================================================

  smoke-tests:
    name: Smoke Tests
    needs: [setup, deploy, integration-tests]
    runs-on: ubuntu-latest
    if: ${{ needs.setup.outputs.should_run_e2e == 'true' && always() }}
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: tests

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: tests

      - name: Create dynamic environment file
        run: |
          cat > tests/config/.env.${{ needs.setup.outputs.env_name }} << EOF
          BASE_URL=${{ needs.deploy.outputs.frontend_url }}
          API_URL=${{ needs.deploy.outputs.api_url }}
          AUTH_URL=${{ needs.deploy.outputs.auth_url }}
          TEST_USER_EMAIL=test@example.com
          TEST_USER_PASSWORD=testpassword123
          EOF

      - name: Run E2E smoke tests
        run: TEST_ENV=${{ needs.setup.outputs.env_name }} npm run test:e2e:smoke
        working-directory: tests
        env:
          CI: true

      - name: Generate timestamp
        if: always()
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)" >> $GITHUB_OUTPUT

      - name: Organize test results
        if: always()
        run: |
          mkdir -p reports/${{ steps.timestamp.outputs.value }}/smoke-tests
          if [ -d "reports" ]; then
            find reports -maxdepth 1 -type f -exec mv {} reports/${{ steps.timestamp.outputs.value }}/smoke-tests/ \; 2>/dev/null || true
          fi
          if [ -d "test-results" ]; then
            mv test-results reports/${{ steps.timestamp.outputs.value }}/smoke-tests/ 2>/dev/null || true
          fi
        working-directory: tests

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-tests-${{ needs.setup.outputs.env_name }}-${{ steps.timestamp.outputs.value }}
          path: tests/reports/${{ steps.timestamp.outputs.value }}/smoke-tests/
          retention-days: 7
