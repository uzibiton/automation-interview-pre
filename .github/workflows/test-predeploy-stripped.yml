name: 'Test: Pre-Deploy Stripped'

on:
  workflow_call:
    inputs:
      skip_unit_tests:
        type: boolean
        default: false
      skip_snyk:
        type: boolean
        default: false
    secrets:
      SNYK_TOKEN:
        required: false
    outputs:
      timestamp:
        description: 'CI Run timestamp'
        value: ${{ jobs.generate-timestamp.outputs.timestamp }}

jobs:
  generate-timestamp:
    name: Generate CI Run ID
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.value }}
    steps:
      - name: Generate timestamp for this CI run
        id: timestamp
        run: echo "value=$(date -u +%Y-%m-%dT%H-%M-%S-%3NZ)" >> $GITHUB_OUTPUT

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: [generate-timestamp]
    steps:
      - name: Start Security Checks
        run: echo "Starting security checks"

  snyk:
    name: Security Scan
    needs: [security-checks, generate-timestamp]
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_snyk }}
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk scan
        id: snyk
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --all-projects --sarif-file-output=snyk.sarif

      - name: Organize security results
        if: always() && hashFiles('snyk.sarif') != ''
        run: |
          mkdir -p reports/${{ needs.generate-timestamp.outputs.timestamp }}/security-scan
          mv snyk.sarif reports/${{ needs.generate-timestamp.outputs.timestamp }}/security-scan/

  gate:
    name: Gate
    needs: [snyk]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: echo "Snyk: ${{ needs.snyk.result }}"
