name: Cleanup PR Environment

on:
  pull_request:
    types: [closed]
    branches:
      - main

  # Manual trigger to cleanup any PR environment
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to cleanup'
        required: true
        type: string

jobs:
  cleanup:
    name: Cleanup PR-${{ github.event.pull_request.number || github.event.inputs.pr_number }} Environment
    runs-on: ubuntu-latest
    # Only run cleanup if services were likely deployed (skip for manual trigger)
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete PR services
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.inputs.pr_number }}"
          SUFFIX="-pr-${PR_NUMBER}"
          REGION="us-central1"

          echo "ðŸ§¹ Cleaning up PR environment: pr-${PR_NUMBER}"

          # Delete services if they exist
          for service in expense-tracker api-service auth-service frontend; do
            if gcloud run services describe ${service}${SUFFIX} --region ${REGION} 2>/dev/null; then
              echo "Deleting ${service}${SUFFIX}..."
              gcloud run services delete ${service}${SUFFIX} --region ${REGION} --quiet
            else
              echo "${service}${SUFFIX} not found, skipping..."
            fi
          done

          echo "âœ… Cleanup complete!"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ§¹ PR environment `pr-${{ github.event.pull_request.number }}` has been cleaned up and all Cloud Run services have been deleted.'
            });
