name: Clean Up

on:
  pull_request:
    types: [closed]
    branches:
      - main

  # Manual trigger to cleanup any deployed environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to clean up'
        required: true
        type: choice
        options:
          - pr
          - develop
          - staging
        default: pr
      pr_number:
        description: 'PR number (required for PR environments)'
        required: false
        type: string

jobs:
  cleanup:
    name: Clean Up ${{ github.event.pull_request.number && format('PR-{0}', github.event.pull_request.number) || inputs.environment == 'pr' && format('PR-{0}', inputs.pr_number) || inputs.environment }}
    runs-on: ubuntu-latest
    # Only run cleanup if services were likely deployed
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Determine environment suffix
        id: env
        run: |
          ENV="${{ inputs.environment }}"
          PR_NUMBER="${{ github.event.pull_request.number || inputs.pr_number }}"

          # Determine suffix based on environment type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SUFFIX="-pr-${PR_NUMBER}"
            ENV_NAME="pr-${PR_NUMBER}"
          elif [[ "$ENV" == "pr" ]]; then
            if [[ -z "$PR_NUMBER" ]]; then
              echo "âŒ PR number required for PR environments"
              exit 1
            fi
            SUFFIX="-pr-${PR_NUMBER}"
            ENV_NAME="pr-${PR_NUMBER}"
          elif [[ "$ENV" == "develop" ]]; then
            SUFFIX="-dev"
            ENV_NAME="develop"
          elif [[ "$ENV" == "staging" ]]; then
            SUFFIX="-staging"
            ENV_NAME="staging"
          else
            echo "âŒ Unknown environment: $ENV"
            exit 1
          fi

          echo "suffix=${SUFFIX}" >> $GITHUB_OUTPUT
          echo "env_name=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Target environment: ${ENV_NAME} (suffix: ${SUFFIX})"

      - name: Delete Cloud Run services
        run: |
          SUFFIX="${{ steps.env.outputs.suffix }}"
          ENV_NAME="${{ steps.env.outputs.env_name }}"
          REGION="us-central1"

          echo "ðŸ§¹ Cleaning up environment: ${ENV_NAME}"

          # Delete services if they exist
          for service in expense-tracker api-service auth-service frontend; do
            if gcloud run services describe ${service}${SUFFIX} --region ${REGION} 2>/dev/null; then
              echo "Deleting ${service}${SUFFIX}..."
              gcloud run services delete ${service}${SUFFIX} --region ${REGION} --quiet
            else
              echo "${service}${SUFFIX} not found, skipping..."
            fi
          done

          # Delete frontend bucket for PR environments
          if [[ "${{ inputs.environment || 'pr' }}" == "pr" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number || inputs.pr_number }}"
            BUCKET="expense-tracker-frontend-pr-${PR_NUMBER}"
            if gsutil ls gs://${BUCKET} 2>/dev/null; then
              echo "Deleting bucket: ${BUCKET}"
              gsutil -m rm -r gs://${BUCKET} || true
            fi
          fi

          echo "âœ… Cleanup complete!"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ§¹ PR environment `pr-${{ github.event.pull_request.number }}` has been cleaned up and all Cloud Run services have been deleted.'
            });
